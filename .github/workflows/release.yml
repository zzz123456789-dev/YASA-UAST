name: Release Pipeline

on:
  push:
    tags:
      - 'v*'  # ÊîØÊåÅ v1.0.0 Âíå v1.0.0-beta.1

jobs:
  # 1. ÊèêÂèñÁâàÊú¨ÂíåÂèëÂ∏ÉÈÄöÈÅì
  get_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      npm_tag: ${{ steps.extract.outputs.npm_tag }}
    steps:
      - name: Extract version and tag
        id: extract
        run: |
          echo "üîç Raw GITHUB_REF: $GITHUB_REF"
          tag="${GITHUB_REF#refs/tags/v}"
          echo "üì¶ Extracted version tag: $tag"
          
          echo "version=$tag" >> $GITHUB_OUTPUT
          
          if [[ "$tag" == *"-beta."* ]]; then
            echo "üîñ Detected beta release, using npm tag: beta"
            echo "npm_tag=beta" >> $GITHUB_OUTPUT
          else
            echo "üîñ Detected stable release, using npm tag: latest"
            echo "npm_tag=latest" >> $GITHUB_OUTPUT
          fi

  # Job 2: Build for macOS (Intel & Apple Silicon)
  build_python_macos:
    name: Build Python Binary - macOS Universal
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-15-intel, macos-latest]
        arch:
          - amd64
          - arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.arch }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install Dependencies and Build
        working-directory: parser-Python
        shell: bash
        run: |
            echo "üèóÔ∏è Building for mac ${{ matrix.arch }}"
            python -m venv .venv
            source .venv/bin/activate
            pip install -r requirements.txt
            pip install pyinstaller
            pyinstaller --onefile uast/builder.py

            mkdir -p dist
            OUTPUT_NAME="uast4py-mac-${{ matrix.arch }}"
            mv dist/builder "dist/$OUTPUT_NAME"
            echo "‚úÖ Built: dist/$OUTPUT_NAME"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-mac-${{ matrix.arch }}
          path: parser-Python/dist/uast4py-mac-${{ matrix.arch }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-windows-amd64
          path: parser-Python/dist/uast4py-windows-amd64.exe

  # 6. ÂêàÂπ∂‰∫ßÁâ©Âπ∂ÂàõÂª∫ GitHub Release
  create_release:
    # needs: [build_go, build_python_linux, build_python_macos, build_python_windows]
    needs: [build_python_macos]
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: releases/
        continue-on-error: true  # Èò≤Ê≠¢Êüê‰∏™ artifact ‰∏ãËΩΩÂ§±Ë¥•ÂØºËá¥‰∏≠Êñ≠

      - name: List downloaded files
        run: |
          echo "üìÇ Downloaded artifacts:"
          find releases -type f

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref }}
          name: Release ${{ github.ref }}
          artifacts: "releases/**/*"
          token: ${{ secrets.GITHUB_TOKEN }}
